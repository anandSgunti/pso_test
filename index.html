<!DOCTYPE html>
<html>
<head>
    <title>Interactive WebAR Model Viewer</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>
    
    <style>
        .arjs-loader {
            position: fixed;
            z-index: 999;
            overflow: show;
            margin: auto;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 50px;
            height: 50px;
        }
        
        .arjs-loader div {
            position: absolute;
            width: 44px;
            height: 44px;
            margin: 8px;
            border: 4px solid #fff;
            border-radius: 50%;
            border-color: #fff transparent transparent transparent;
            animation: arjs-loader 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }

        @keyframes arjs-loader {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #instructions {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-family: Arial, sans-serif;
            z-index: 1000;
            text-align: center;
            width: 80%;
        }

        #lighting-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-family: Arial, sans-serif;
            z-index: 1000;
            text-align: center;
            width: 80%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex-grow: 1;
        }

        .value-display {
            min-width: 40px;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <div class="arjs-loader">
        <div></div>
    </div>
    <div id="instructions">
        ‚ü≤ One finger rotate | ‚ÜîÔ∏è Two fingers scale | üëÜ Double tap to reset
    </div>
    <div id="lighting-controls">
        <div class="slider-container">
            <label>Ambient Light:</label>
            <input type="range" id="ambient-light" min="0" max="2" step="0.1" value="0.5">
            <span class="value-display" id="ambient-value">0.5</span>
        </div>
        <div class="slider-container">
            <label>Directional Light:</label>
            <input type="range" id="directional-light" min="0" max="2" step="0.1" value="0.8">
            <span class="value-display" id="directional-value">0.8</span>
        </div>
    </div>

    <a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false;"
        vr-mode-ui="enabled: false"
        gesture-detector
        renderer="physicallyCorrectLights: true; colorManagement: true; exposure: 1;"
    >
        <a-entity light="type: ambient; intensity: 0.5; color: #ffffff" id="ambient-light-entity"></a-entity>
        
        <a-marker preset="hiro" smooth="true" smoothCount="5">
            <a-entity light="type: directional; 
                             color: #ffffff; 
                             intensity: 0.8; 
                             castShadow: true" 
                      position="1 1 1"
                      id="directional-light-entity">
            </a-entity>

            <a-entity light="type: directional; 
                             color: #ffffff; 
                             intensity: 0.5;" 
                      position="-1 1 0">
            </a-entity>

            <a-entity light="type: point;
                             color: #ffffff;
                             intensity: 0.5;
                             distance: 50"
                      position="0 2 0">
            </a-entity>

            <a-entity
                id="model"
                position="0 0 0"
                rotation="0 0 0"
                scale="1 1 1"
                gltf-model="./he.glb"
                gesture-handler="minScale: 0.25; maxScale: 10"
                animation-mixer
                material="metalness: 0.1; roughness: 0.5;"
                shadow="cast: true; receive: true">
            </a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Light control initialization
        const ambientSlider = document.getElementById('ambient-light');
        const directionalSlider = document.getElementById('directional-light');
        const ambientValue = document.getElementById('ambient-value');
        const directionalValue = document.getElementById('directional-value');
        
        // Update ambient light
        ambientSlider.addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('ambient-light-entity').setAttribute('light', 'intensity', value);
            ambientValue.textContent = value;
        });

        // Update directional light
        directionalSlider.addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('directional-light-entity').setAttribute('light', 'intensity', value);
            directionalValue.textContent = value;
        });

        // Component for dynamic lighting control
        AFRAME.registerComponent('light-control', {
            init: function() {
                this.model = document.getElementById('model');
                this.updateLighting();
            },
            
            updateLighting: function() {
                document.querySelector('a-marker').addEventListener('markerFound', () => {
                    // Set initial light values when marker is found
                    document.getElementById('ambient-light-entity').setAttribute('light', 'intensity', ambientSlider.value);
                    document.getElementById('directional-light-entity').setAttribute('light', 'intensity', directionalSlider.value);
                });
            }
        });

        window.addEventListener('load', () => {
            const model = document.getElementById('model');
            const marker = document.querySelector('a-marker');
            
            document.querySelector('a-scene').setAttribute('light-control', '');
            
            marker.addEventListener('markerFound', () => {
                console.log('Marker detected');
            });

            // Double tap to reset
            let lastTap = 0;
            document.addEventListener('click', (event) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 500 && tapLength > 0) {
                    model.setAttribute('rotation', '0 0 0');
                    model.setAttribute('scale', '1 1 1');
                }
                lastTap = currentTime;
            });

            // Handle model loading
            model.addEventListener('model-loaded', () => {
                console.log('Model loaded');
                model.setAttribute('material', {
                    metalness: 0.1,
                    roughness: 0.5
                });
            });
        });
    </script>
</body>
</html>
