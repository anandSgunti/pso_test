<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive WebAR Chat</title>
    
    <!-- A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>

    <style>
        /* Overall Layout */
        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(180deg, #eef2f3, #cfd9df);
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 1200px;
        }

        /* AR Heart Section */
        #heart-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Chat Section */
        #chat-section {
            flex: 1;
            text-align: left;
            padding: 20px;
            max-width: 500px;
        }

        /* Heading */
        #chat-section h2 {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        /* Chat Input Bar */
        .chat-input-bar {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* Input Field */
        .chat-input-bar input {
            flex: 1;
            padding: 8px;
            border-radius: 20px;
            border: none;
            background: transparent;
            color: black;
            font-size: 14px;
            outline: none;
        }

        /* Send Button */
        .send-button {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
        }

        .send-button img {
            width: 20px;
            height: 20px;
        }

        /* Chat Response (Speech Bubble) */
        #chat-response-container {
            margin-top: 15px;
            padding: 10px;
            max-width: 80%;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-size: 16px;
            color: black;
            line-height: 1.4;
            text-align: left;
            display: none;
        }

        /* Thinking Animation */
        .thinking-animation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            padding: 10px;
        }

        .thinking-animation span {
            width: 8px;
            height: 8px;
            background-color: black;
            border-radius: 50%;
            opacity: 0.6;
            animation: bounce 1.5s infinite ease-in-out;
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.6; }
            40% { transform: translateY(-6px); opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="container">
        <!-- 3D AR Heart Model -->
        <div id="heart-container">
            <a-scene embedded arjs>
                <a-marker preset="hiro">
                    <a-entity gltf-model="./reheart.glb" 
                              position="0 0 0" 
                              rotation="0 180 0" 
                              scale="1 1 1"
                              gesture-handler
                              animation-mixer>
                    </a-entity>
                </a-marker>
                <a-camera position="0 0 0"></a-camera>
            </a-scene>
        </div>

        <!-- Chat Section -->
        <div id="chat-section">
            <h2>Ask me about Broken Heart Syndrome...</h2>

            <!-- Chat Input -->
            <div class="chat-input-bar">
                <input type="text" id="user-message" placeholder="Type your question..." onkeypress="handleKeyPress(event)">
                <button class="send-button" onclick="sendMessage()">
                    <img src="https://cdn-icons-png.flaticon.com/512/786/786205.png" alt="Send">
                </button>
            </div>

            <!-- Chat Response (Speech Bubble) -->
            <div id="chat-response-container">
                <div id="thinking-animation" class="thinking-animation" style="display: none;">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        AFRAME.registerComponent('max-brightness', {
            init: function() {
                const model = document.getElementById('model');
                const lights = document.querySelectorAll('[light]');

                // Maximize brightness on marker detection
                document.querySelector('a-marker').addEventListener('markerFound', () => {
                    lights.forEach(light => {
                        light.setAttribute('light', 'intensity', 3);
                    });

                    // Additional brightness enhancement
                    model.setAttribute('material', {
                        emissiveIntensity: 1,
                        metalness: 0.1,
                        roughness: 0.1
                    });

                    // Automatically request AI response
                    getChatResponse("Describe this AR object.");
                });
            }
        });

        window.addEventListener('load', () => {
            const model = document.getElementById('model');
            const marker = document.querySelector('a-marker');
            
            // Add max brightness component
            document.querySelector('a-scene').setAttribute('max-brightness', '');
            
            // Double tap reset functionality
            let lastTap = 0;
            document.addEventListener('click', (event) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 500 && tapLength > 0) {
                    model.setAttribute('rotation', '0 0 0');
                    model.setAttribute('scale', '1 1 1');
                }
                lastTap = currentTime;
            });
        });

        // Handle Enter Key Press
        function handleKeyPress(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        }

        // Function to Send User Input to AI
        function sendMessage() {
            const userMessage = document.getElementById("user-message").value;
            const chatResponseContainer = document.getElementById("chat-response-container");
            const thinkingAnimation = document.getElementById("thinking-animation");

            if (userMessage) {
                chatResponseContainer.innerHTML = "";
                chatResponseContainer.style.display = "block";
                thinkingAnimation.style.display = "flex";
                chatResponseContainer.appendChild(thinkingAnimation);
                getChatResponse(userMessage);
                document.getElementById("user-message").value = "";
            }
        }

        // Chatbot API Integration (Streaming AI Response)
        async function getChatResponse(userMessage) {
            const response = await fetch("https://ari-b6xq.onrender.com/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: userMessage })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let finalResponse = "";
            const chatResponseContainer = document.getElementById("chat-response-container");
            const thinkingAnimation = document.getElementById("thinking-animation");

            chatResponseContainer.innerHTML = "";
            chatResponseContainer.style.display = "block";

            const chatBubble = document.createElement("div");
            chatBubble.classList.add("chat-bubble");
            chatBubble.innerText = "Thinking...";
            chatResponseContainer.appendChild(chatBubble);

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                finalResponse += decoder.decode(value);
                chatBubble.innerText = finalResponse;
            }

            thinkingAnimation.style.display = "none";
        }
    </script>

</body>
</html>
