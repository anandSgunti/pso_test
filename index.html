<!DOCTYPE html>
<html>
<head>
  <title>Interactive WebAR Model Viewer - Static Placement</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      background: linear-gradient(180deg, #eef2f3, #cfd9df);
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    /* Chat UI Section */
    #chat-section {
      position: absolute;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      max-width: 320px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    #chat-section h2 {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    .chat-input-bar {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      padding: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    .chat-input-bar input {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: none;
      background: transparent;
      color: black;
      font-size: 14px;
      outline: none;
    }
    .send-button {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px;
    }
    .send-button img {
      width: 20px;
      height: 20px;
    }
    #chat-response-container {
      margin-top: 15px;
      padding: 10px;
      max-width: 90%;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      font-size: 16px;
      color: black;
      line-height: 1.4;
      text-align: left;
      display: none;
    }
    .thinking-animation {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
      padding: 10px;
    }
    .thinking-animation span {
      width: 8px;
      height: 8px;
      background-color: black;
      border-radius: 50%;
      opacity: 0.6;
      animation: bounce 1.5s infinite ease-in-out;
    }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: 0.6; }
      40% { transform: translateY(-6px); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="arjs-loader">
    <div></div>
  </div>

  <!-- AR Scene without Marker (Static Placement) -->
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;"
           vr-mode-ui="enabled: false"
           gesture-detector
           renderer="physicallyCorrectLights: true; colorManagement: true; exposure: 2; toneMappingMethod: linear;">
    
    <!-- Lighting Setup -->
    <a-entity light="type: ambient; intensity: 2; color: #FFFFFF"></a-entity>
    <a-entity light="type: directional; color: #FFFFFF; intensity: 2; castShadow: true" position="1 4 2"></a-entity>
    <a-entity light="type: directional; color: #FFFFFF; intensity: 1.5;" position="-1 4 -2"></a-entity>
    <a-entity light="type: point; color: #FFFFFF; intensity: 1.5; distance: 100" position="0 3 0"></a-entity>
    
    <!-- 3D Model Placed Statically 2 Units in Front of the Camera -->
    <a-entity id="model"
              position="0 0 -2"
              rotation="0 0 0"
              scale="0.02 0.02 0.02"
              gltf-model="./heart_A.glb"
              gesture-handler="minScale: 0.01; maxScale: 0.1"
              animation-mixer
              material="metalness: 0.1; roughness: 0.2; emissive: #FFFFFF; emissiveIntensity: 0.5; color: #FFFFFF;"
              shadow="cast: true; receive: false">
    </a-entity>
    
    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>

  <!-- Chat UI for AI Interaction -->
  <div id="chat-section">
    <h2>Ask me about Broken Heart Syndrome...</h2>
    <div class="chat-input-bar">
      <input type="text" id="user-message" placeholder="Type your question..." onkeypress="handleKeyPress(event)">
      <button class="send-button" onclick="sendMessage()">
        <img src="https://cdn-icons-png.flaticon.com/512/786/786205.png" alt="Send">
      </button>
    </div>
    <div id="chat-response-container">
      <div id="thinking-animation" class="thinking-animation" style="display: none;">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

  <script>
    // Double tap to reset model rotation and scale
    window.addEventListener('load', () => {
      const model = document.getElementById('model');
      let lastTap = 0;
      document.addEventListener('click', () => {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 500 && tapLength > 0) {
          model.setAttribute('rotation', '0 0 0');
          model.setAttribute('scale', '1 1 1');
        }
        lastTap = currentTime;
      });
    });

    // Handle Enter key press for chat input
    function handleKeyPress(event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    }

    // Send user input to AI and display the streaming response
    function sendMessage() {
      const userMessage = document.getElementById("user-message").value;
      const chatResponseContainer = document.getElementById("chat-response-container");
      const thinkingAnimation = document.getElementById("thinking-animation");

      if (userMessage) {
        chatResponseContainer.innerHTML = "";
        chatResponseContainer.style.display = "block";
        thinkingAnimation.style.display = "flex";
        chatResponseContainer.appendChild(thinkingAnimation);
        getChatResponse(userMessage);
        document.getElementById("user-message").value = "";
      }
    }

    async function getChatResponse(userMessage) {
      const response = await fetch("https://ari-b6xq.onrender.com/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: userMessage })
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let finalResponse = "";
      const chatResponseContainer = document.getElementById("chat-response-container");
      const thinkingAnimation = document.getElementById("thinking-animation");

      chatResponseContainer.innerHTML = "";
      chatResponseContainer.style.display = "block";

      const chatBubble = document.createElement("div");
      chatBubble.classList.add("chat-bubble");
      chatBubble.innerText = "Thinking...";
      chatResponseContainer.appendChild(chatBubble);

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        finalResponse += decoder.decode(value);
        chatBubble.innerText = finalResponse;
      }

      thinkingAnimation.style.display = "none";
    }
  </script>
</body>
</html>
